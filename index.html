<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebXR Video Smoke — v0.7</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #hud{position:fixed;z-index:3;left:16px;top:16px;display:flex;gap:8px;align-items:center;color:#ddd}
    .pill{background:#303030;border-radius:999px;padding:6px 10px;font-size:12px}
    #status{opacity:.85}
    #overlay{
      position:fixed;inset:0;display:flex;flex-direction:column;gap:12px;
      align-items:center;justify-content:center;z-index:4;background:rgba(0,0,0,.35)
    }
    .btn{
      background:#00a86b;border:none;color:#fff;font-weight:700;font-size:18px;
      padding:14px 22px;border-radius:12px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
    .btn.secondary{background:#1e90ff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    #diag{position:fixed;left:12px;bottom:12px;color:#aaa;font-size:12px;white-space:pre-line;z-index:3;max-width:90vw}
    video{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px}
    canvas{display:block}
  </style>
</head>
<body>
  <div id="hud">
    <span class="pill">Build v0.7</span>
    <span id="status" class="pill">idle</span>
  </div>

  <div id="overlay">
    <button id="playBtn" class="btn">Play</button>
    <button id="vrBtn" class="btn secondary" disabled>Enter VR</button>
    <div style="color:#bbb;font-size:13px">Tip: tap anywhere if the button seems unresponsive</div>
  </div>

  <video id="vid" playsinline muted crossorigin="anonymous"></video>
  <div id="diag"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

    // ===== Config: plain MP4 to avoid HLS edge-cases =====
    const STREAM_URL = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';

    // ===== DOM =====
    const video = document.getElementById('vid');
    const statusEl = document.getElementById('status');
    const playBtn = document.getElementById('playBtn');
    const vrBtn   = document.getElementById('vrBtn');
    const overlay = document.getElementById('overlay');
    const diag    = document.getElementById('diag');

    // ===== XR/Three =====
    let renderer, scene, camera, plane, videoTex;

    initThree();
    setupPlane();
    animate();
    hardenGestures();
    checkXR();

    // Make *any* tap try to play (Quest sometimes drops clicks)
    function hardenGestures(){
      const tryPlay = () => startPlayback().catch(()=>{});
      ['pointerdown','pointerup','click','touchstart','touchend','keydown'].forEach(ev=>{
        document.addEventListener(ev, (e)=>{
          if (overlay.style.display !== 'none') tryPlay();
        }, { passive:true });
      });
      playBtn.addEventListener('click', tryPlay);
      vrBtn.addEventListener('click', enterVR);
    }

    async function startPlayback(){
      overlay.style.display = 'none';
      status('loading…');
      try{
        video.src = STREAM_URL;
        await video.play();           // user gesture required
        video.muted = false;          // unmute after gesture
        bindTexture();
        status('playing');
        await checkXR(true);          // re-check XR after user gesture
        vrBtn.disabled = false;       // allow trying VR regardless; we'll catch errors
      }catch(e){
        status('playback blocked');
        overlay.style.display = 'flex';
        logDiag('play() error: ' + (e && e.message ? e.message : e));
        throw e;
      }
    }

    function bindTexture(){
      if (!videoTex) {
        videoTex = new THREE.VideoTexture(video);
        videoTex.colorSpace = THREE.SRGBColorSpace;
        videoTex.minFilter = THREE.LinearFilter;
        videoTex.magFilter = THREE.LinearFilter;
        videoTex.generateMipmaps = false;
      }
      plane.material.map = videoTex;
      plane.material.needsUpdate = true;
    }

    async function enterVR(){
      if (!navigator.xr) { status('WebXR missing'); logDiag('navigator.xr is undefined'); return; }
      try{
        const session = await navigator.xr.requestSession('immersive-vr', {
          requiredFeatures: ['local-floor'],
          optionalFeatures: ['hand-tracking']
        });
        renderer.xr.setSession(session);
        status('VR started');
        session.addEventListener('end', ()=>{
          status('VR ended');
          if (video.paused) video.play().catch(()=>{ overlay.style.display='flex'; });
        });
      }catch(e){
        status('VR failed');
        logDiag('requestSession error: ' + (e && e.message ? e.message : e));
      }
    }

    async function checkXR(afterGesture=false){
      const httpsOK = (location.protocol === 'https:') || (location.hostname === 'localhost');
      const xrOK = !!navigator.xr;
      let supported = false;
      try { supported = xrOK ? await navigator.xr.isSessionSupported('immersive-vr') : false; }
      catch(e) { logDiag('isSessionSupported threw: ' + e); }
      diag.textContent =
        `Secure context (https): ${httpsOK}\n`+
        `navigator.xr: ${xrOK}\n`+
        `'immersive-vr' supported: ${supported}\n`+
        (afterGesture ? '(rechecked after user gesture)\n' : '');
      vrBtn.disabled = !supported && !afterGesture; // allow manual try after gesture
    }

    function status(msg){ statusEl.textContent = msg; }
    function logDiag(msg){ diag.textContent += (diag.textContent ? '\n' : '') + msg; }

    // ===== Three boilerplate =====
    function initThree(){
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
      camera.position.set(0, 1.6, 0);

      scene.add(new THREE.AmbientLight(0xffffff, 0.7));

      const floor = new THREE.Mesh(
        new THREE.CircleGeometry(3.5, 64),
        new THREE.MeshBasicMaterial({ color:0x101010 })
      );
      floor.rotation.x = -Math.PI/2;
      floor.position.y = 0;
      scene.add(floor);

      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function setupPlane(){
      const geom = new THREE.PlaneGeometry(2.8, 1.575);
      const mat  = new THREE.MeshBasicMaterial({ color:0xffffff });
      plane = new THREE.Mesh(geom, mat);
      plane.position.set(0, 1.6, -2.0);
      scene.add(plane);

      video.addEventListener('loadedmetadata', ()=>{
        const w = video.videoWidth || 16, h = video.videoHeight || 9;
        const aspect = w / Math.max(1, h);
        const width = 2.8, height = width / aspect;
        plane.geometry.dispose();
        plane.geometry = new THREE.PlaneGeometry(width, height);
      });
    }

    function animate(){
      renderer.setAnimationLoop(()=>{
        if (plane.material.map === videoTex && !video.paused && !video.ended) {
          videoTex.needsUpdate = true;
        }
        renderer.render(scene, camera);
      });
    }
  </script>
</body>
</html>