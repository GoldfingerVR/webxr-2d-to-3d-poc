<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebXR 2D → Stereo POC — v0.13 (no proxy)</title>

  <!-- hls.js for .m3u8 playback in browsers without native HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <!-- Three.js (module) -->
  <script type="module" src="https://unpkg.com/three@0.160.0/build/three.module.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    video{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px}
    canvas{display:block}

    #hud{position:fixed;z-index:3;left:16px;top:16px;display:flex;gap:8px;align-items:center}
    .pill{background:#303030;color:#e0e0e0;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid #444}
    .btn-pill{cursor:pointer;user-select:none}
    .btn-pill[aria-disabled="true"]{opacity:.45;cursor:not-allowed}
    #status{opacity:.85}

    #overlay{
      position:fixed;inset:0;display:flex;flex-direction:column;gap:14px;
      align-items:center;justify-content:center;z-index:4;background:rgba(0,0,0,.55)
    }
    .cta{
      background:#00a86b;border:none;color:#fff;font-weight:700;font-size:18px;
      padding:14px 22px;border-radius:12px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
    .hint{color:#bbb;font-size:13px;text-align:center}

    #diag{position:fixed;left:12px;bottom:12px;color:#aaa;font-size:12px;white-space:pre-line;z-index:3;max-width:92vw}
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    <span class="pill">Build v0.13</span>
    <span id="enterVR" class="pill btn-pill" aria-disabled="true">Enter VR</span>
    <span id="status" class="pill">idle</span>
  </div>

  <!-- Autoplay gate -->
  <div id="overlay" aria-hidden="false">
    <button id="playBtn" class="cta">Enable Autoplay</button>
    <div class="hint">Tap once to start playback, then use “Enter VR” (top-left).</div>
  </div>

  <!-- Hidden media source -->
  <video id="vid" playsinline muted crossorigin="anonymous"></video>

  <!-- Debug -->
  <div id="diag"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

    // ---------- Config ----------
    // Provide your HLS or MP4 via ?u=... (no proxy needed)
    const q = new URLSearchParams(location.search);
    const STREAM_URL = q.get('u') || 'https://aps13.playlist.ttvnw.net/v1/playlist/CroGdx8CyTiO8JfGjv-zArDw93tQKeFhr4UGsh34Tb_6Lcgp9kG7ytlTP96cO-EiZ-I06VJgNkhTD4uzuiJk7938GYD4rpCe7jrhbAg6QwcYUVIIlmXvS5q6V7tJYKJLy2lULxYvbyQPJVIM6J1qwJC6NMftTP0rxnsOoMJFNG4043-cG84uBMgHjA6BZ2IDzFGV1fni1_9dVOd9XxJi7IhWG_0h_WsC0j6tPuP1JTP4LPN5hh0TKNk7UrAq9xk02qyaQb4kq6682mNQFyIccHSpQWyUkPkpuBoAa0gQjnmIyJJqqDx1-zKYZw56r7-OU2NoYXC8AHzpHMnk6GOrB6P2EtFvL2ssler1Wqe-kPojHH9nk2hSVSRuZ46wXHuQKkYI8vtH03sxwt7ArmRowW7bC4TLF3f4RoDVg_uVWzqDtrpTEsTmTMCag-YNySyN3LBLlyYr2jTqNQ7f-rf7T8ShtxKfoUngz-CAci6eqd0LskmqLaTVrtgImltGk2-XUqgYQviziHBJIYvQBXQZASIIVJAgqDUVgatECPYZi68szLYv5juAq4L4Aq-_2yN-X32EdyHyMwOA65xm7tu593ACoGo-0V_bbu1QNQCG0sKBCR2HOeReqE9bhK86LvZ1NpAPen8RVKEM8giwy8mkzmFtq-CSWL16ZTu-7w2DCBZi4adh60O0DAmrUIFDHAHNCfuqhbJQ5nph8gfpjdfy-kylDQVARXXBJrNv0jb6vmRcO0Lv8IzgNy4sn1SzK1FnauwkYpeYFJmXUSe5N06FnRJgXVf4ZcE0-5DDrHjUP1AbTm5W4Lg5kBd-Q7Sc5rsejt1FGz8cKLJHMiYWoiu-M5eMNh1_tWH6S_8uL5AdbmOXqwWvQEQNVAbwfh7LKIvqWkDjfL5G5Op5VQYRd-6ZU3SmzPKdTYPO3F5kRwv0uZ8VmR190KjTakLVaz9sHlbeYHeaZ07u_aCkgsIonT3DFziyzrrftaS_6QOOttI0SQVCX0Fu2bCc0Z1hgdLjryq0Agj9JwbMQsHW7prL4ndDDo7wDtgX5LGwT8VCbs9S0euASrXljDAYHdVsiNOJEmXDllZJ8Q2fme7-HJacvhoMffrb2WRLQ5Ye3J-hIAEqCWV1LXdlc3QtMjD6DA.m3u8';

    // Inter-ocular separation in meters (keep small to avoid eyestrain)
    const PARALLAX_M = 0.035;

    // ---------- DOM ----------
    const video   = document.getElementById('vid');
    const playBtn = document.getElementById('playBtn');
    const overlay = document.getElementById('overlay');
    const statusE = document.getElementById('status');
    const enterVR = document.getElementById('enterVR');
    const diag    = document.getElementById('diag');

    // ---------- Three / XR ----------
    let renderer, scene, camera;
    let videoTex, monoPlane = null;
    let stereo = { left:null, right:null };
    let xrSession = null;

    initThree();
    createMonoPlane();  // placeholder until we build stereo
    animate();
    wireUI();
    probeXR();          // enable/disable Enter VR

    // ---------- UI wiring ----------
    function wireUI(){
      const tryPlay = () => startPlayback().catch(()=>{});
      ['pointerdown','click','touchstart','keydown'].forEach(ev=>{
        overlay.addEventListener(ev, tryPlay, { passive:true });
      });
      playBtn.addEventListener('click', tryPlay);

      enterVR.addEventListener('click', async ()=>{
        if (enterVR.getAttribute('aria-disabled') === 'true') {
          log('Enter VR pressed but XR unsupported (still trying)…');
          return;
        }
        await startXR();
      });
    }

    // ---------- Playback ----------
    function isHls(url){ return /\.m3u8(\?|$)/i.test(url); }

    async function startPlayback(){
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden','true');
      status('loading…');

      try{
        video.muted = true;           // required for gesture-autoplay on mobile/VR
        video.playsInline = true;
        video.crossOrigin = 'anonymous';

        if (isHls(STREAM_URL) && window.Hls && Hls.isSupported()) {
          const hls = new Hls({
            enableWorker: true,
            lowLatencyMode: true,
            backBufferLength: 30,
            liveSyncDuration: 3
          });
          hls.on(Hls.Events.ERROR, (_, data) => {
            console.warn('[hls.js] error', data);
            status('hls error');
            log('hls.js: ' + (data?.details || 'error'));
          });
          hls.loadSource(STREAM_URL);
          hls.attachMedia(video);
        } else {
          // Native HLS (iOS/Safari) or MP4 fallback
          video.src = STREAM_URL;
        }

        await video.play();           // needs the user gesture we just got
        video.muted = false;          // safe to unmute now

        bindVideoTexture();
        buildStereoPlanes();          // switch from mono to stereo planes

        status('playing');
        await probeXR(true);
      }catch(e){
        status('playback blocked');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');
        log('play() error: ' + (e?.message || e));
        throw e;
      }
    }

    function bindVideoTexture(){
      if (!videoTex) {
        videoTex = new THREE.VideoTexture(video);
        videoTex.colorSpace = THREE.SRGBColorSpace;
        videoTex.minFilter = THREE.LinearFilter;
        videoTex.magFilter = THREE.LinearFilter;
        videoTex.generateMipmaps = false;
      }
      monoPlane.material.map = videoTex;
      monoPlane.material.needsUpdate = true;

      // Keep screen geometry in the right aspect as soon as metadata is available
      video.addEventListener('loadedmetadata', ()=>{
        const w = video.videoWidth || 16, h = video.videoHeight || 9;
        const aspect = w / Math.max(1, h);
        const width = 2.8, height = width / aspect;

        monoPlane.geometry.dispose();
        monoPlane.geometry = new THREE.PlaneGeometry(width, height);

        if (stereo.left && stereo.right) {
          [stereo.left, stereo.right].forEach(mesh=>{
            mesh.geometry.dispose();
            mesh.geometry = new THREE.PlaneGeometry(width, height);
          });
          positionStereoPlanes(width);
        }
      }, { once:true });
    }

    // ---------- Scene ----------
    function createMonoPlane(){
      const geom = new THREE.PlaneGeometry(2.8, 1.575); // gets corrected on metadata
      const mat  = new THREE.MeshBasicMaterial({ color:0xffffff });
      monoPlane = new THREE.Mesh(geom, mat);
      monoPlane.position.set(0, 1.6, -2.0);
      scene.add(monoPlane);
    }

    // Simple stereo: two planes sharing the same video texture, tiny x-shift per eye
    function buildStereoPlanes(){
      if (!videoTex) return;
      monoPlane.visible = false;

      const baseGeom = monoPlane.geometry.clone();
      const mkMat = () => new THREE.MeshBasicMaterial({ color:0xffffff, map: videoTex });

      stereo.left  = new THREE.Mesh(baseGeom.clone(), mkMat());
      stereo.right = new THREE.Mesh(baseGeom.clone(), mkMat());

      stereo.left.position.set(monoPlane.position.x, monoPlane.position.y, monoPlane.position.z);
      stereo.right.position.set(monoPlane.position.x, monoPlane.position.y, monoPlane.position.z);

      // layer masks: 1 = left, 2 = right
      stereo.left.layers.set(1);
      stereo.right.layers.set(2);

      scene.add(stereo.left);
      scene.add(stereo.right);

      const width = baseGeom.parameters.width ?? 2.8;
      positionStereoPlanes(width);
    }

    function positionStereoPlanes(width){
      const shift = PARALLAX_M;
      stereo.left.position.x  = monoPlane.position.x - (shift/2);
      stereo.right.position.x = monoPlane.position.x + (shift/2);

      // small scale pad to hide binocular edges
      const scalePad = 1.01;
      stereo.left.scale.set(scalePad, scalePad, 1);
      stereo.right.scale.set(scalePad, scalePad, 1);
    }

    // ---------- WebXR ----------
    async function startXR(){
      if (!navigator.xr) { status('WebXR not available'); log('navigator.xr is undefined'); return; }
      try{
        xrSession = await navigator.xr.requestSession('immersive-vr', {
          requiredFeatures: ['local-floor'],
          optionalFeatures: ['hand-tracking']
        });
        renderer.xr.setSession(xrSession);
        status('VR started');

        // Make sure each eye renders only its plane
        const xrCam = renderer.xr.getCamera(camera);
        if (xrCam && xrCam.cameras && xrCam.cameras.length >= 2) {
          xrCam.cameras[0].layers.set(1); // left eye
          xrCam.cameras[1].layers.set(2); // right eye
        }

        xrSession.addEventListener('end', ()=>{
          status('VR ended');
          // Keep overlay hidden; allow re-entry; continue playing in 2D if possible
          if (video.paused) {
            video.play().catch(()=>{ /* ignore */ });
          }
        });
      }catch(e){
        status('VR failed');
        log('requestSession error: ' + (e?.message || e));
      }
    }

    async function probeXR(afterGesture=false){
      const httpsOK = (location.protocol === 'https:') || (location.hostname === 'localhost');
      const xrOK = !!navigator.xr;
      let supported = false;
      try { supported = xrOK ? await navigator.xr.isSessionSupported('immersive-vr') : false; }
      catch(e) { log('isSessionSupported threw: ' + e); }

      diag.textContent =
        `URL: ${STREAM_URL}\n`+
        `Secure (https/localhost): ${httpsOK}\n`+
        `navigator.xr present: ${xrOK}\n`+
        `'immersive-vr' supported: ${supported}`+
        (afterGesture ? `\n(rechecked after user gesture)` : '');

      enterVR.setAttribute('aria-disabled', supported ? 'false' : 'true');
    }

    function status(msg){ statusE.textContent = msg; }
    function log(msg){ diag.textContent += (diag.textContent ? '\n' : '') + msg; }

    // ---------- Three boilerplate ----------
    function initThree(){
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
      camera.position.set(0, 1.6, 0);

      scene.add(new THREE.AmbientLight(0xffffff, 0.7));

      // simple floor for orientation
      const floor = new THREE.Mesh(
        new THREE.CircleGeometry(3.5, 64),
        new THREE.MeshBasicMaterial({ color:0x101010 })
      );
      floor.rotation.x = -Math.PI/2;
      floor.position.y = 0;
      scene.add(floor);

      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function animate(){
      renderer.setAnimationLoop(()=>{
        if (videoTex && !video.paused && !video.ended) {
          videoTex.needsUpdate = true;
        }
        // Ensure XR per-eye layers are applied whenever session/cameras change
        if (renderer.xr.isPresenting) {
          const xrCam = renderer.xr.getCamera(camera);
          if (xrCam && xrCam.cameras && xrCam.cameras.length >= 2) {
            xrCam.cameras[0].layers.enable(1);
            xrCam.cameras[1].layers.enable(2);
          }
        }
        renderer.render(scene, camera);
      });
    }
  </script>
</body>
</html>