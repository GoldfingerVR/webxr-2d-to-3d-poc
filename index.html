<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WebXR Video POC — v0.8</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #hud{position:fixed;z-index:3;left:16px;top:16px;display:flex;gap:8px;align-items:center}
    .pill{background:#303030;color:#e0e0e0;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid #444}
    .btn-pill{cursor:pointer;user-select:none}
    .btn-pill[aria-disabled="true"]{opacity:.45;cursor:not-allowed}
    #status{opacity:.85}
    #overlay{
      position:fixed;inset:0;display:flex;flex-direction:column;gap:14px;
      align-items:center;justify-content:center;z-index:4;background:rgba(0,0,0,.5)
    }
    .cta{
      background:#00a86b;border:none;color:#fff;font-weight:700;font-size:18px;
      padding:14px 22px;border-radius:12px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)
    }
    #diag{position:fixed;left:12px;bottom:12px;color:#aaa;font-size:12px;white-space:pre-line;z-index:3;max-width:92vw}
    video{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px}
    canvas{display:block}
  </style>
</head>
<body>
  <!-- HUD (always visible) -->
  <div id="hud">
    <span class="pill">Build v0.8</span>
    <span id="enterVR" class="pill btn-pill" aria-disabled="true">Enter VR</span>
    <span id="status" class="pill">idle</span>
  </div>

  <!-- Autoplay gate -->
  <div id="overlay">
    <button id="playBtn" class="cta">Enable Autoplay</button>
    <div style="color:#bbb;font-size:13px">Tap once to start playback, then use “Enter VR” (top-left).</div>
  </div>

  <!-- Hidden media source -->
  <video id="vid" playsinline muted crossorigin="anonymous"></video>

  <div id="diag"></div>

  <script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/webxr/VRButton.js';

let scene, camera, renderer, video, videoTex, plane;

init();
function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000);

  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
  camera.position.z = 3;

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  document.body.appendChild(VRButton.createButton(renderer));

  // version label
  const div = document.createElement('div');
  div.textContent = 'VR POC v0.9';
  div.style.position = 'absolute';
  div.style.top = '10px';
  div.style.left = '10px';
  div.style.color = 'white';
  div.style.fontFamily = 'monospace';
  div.style.zIndex = '999';
  document.body.appendChild(div);

  // play/autoplay button
  const playBtn = document.createElement('button');
  playBtn.textContent = 'Enable Autoplay & Play Video';
  playBtn.style.position = 'absolute';
  playBtn.style.bottom = '20px';
  playBtn.style.left = '50%';
  playBtn.style.transform = 'translateX(-50%)';
  playBtn.style.padding = '10px 20px';
  playBtn.style.fontSize = '16px';
  document.body.appendChild(playBtn);

  playBtn.addEventListener('click', () => {
    playBtn.remove();
    setupVideo();
  });

  window.addEventListener('resize', onWindowResize);
}

function setupVideo() {
  video = document.createElement('video');
  video.src = 'https://stream.mux.com/KH02NwH01GZ28mI02.m3u8'; // change to your stream
  video.crossOrigin = 'anonymous';
  video.loop = true;
  video.muted = true;
  video.autoplay = true;
  video.playsInline = true;
  video.play();

  videoTex = new THREE.VideoTexture(video);
  videoTex.minFilter = THREE.LinearFilter;
  videoTex.magFilter = THREE.LinearFilter;
  videoTex.format = THREE.RGBFormat;

  setupPlane();
  bindVideoTexture();
  setupStereoParallax();
}

function setupPlane() {
  const geometry = new THREE.PlaneGeometry(2.8, 1.6);
  const material = new THREE.MeshBasicMaterial({ map: videoTex });
  plane = new THREE.Mesh(geometry, material);
  scene.add(plane);
}

function bindVideoTexture() {
  video.addEventListener('loadedmetadata', () => {
    const aspect = video.videoWidth / video.videoHeight;
    plane.geometry.dispose();
    plane.geometry = new THREE.PlaneGeometry(2.8, 2.8 / aspect);
  });
}

// --- NEW: stereo parallax fake 3D ---
function setupStereoParallax(){
  plane.visible = false;

  const makeMat = (shift) => {
    const m = new THREE.MeshBasicMaterial({ map: videoTex });
    m.map.wrapS = THREE.ClampToEdgeWrapping;
    m.map.wrapT = THREE.ClampToEdgeWrapping;
    m.map.needsUpdate = true;
    m.userData.shift = shift;
    return m;
  };

  const geom = plane.geometry.clone();

  const left = new THREE.Mesh(geom.clone(), makeMat(-0.005));
  left.position.copy(plane.position);
  left.layers.set(1);
  scene.add(left);

  const right = new THREE.Mesh(geom.clone(), makeMat(+0.005));
  right.position.copy(plane.position);
  right.layers.set(2);
  scene.add(right);

  const applyShift = (mesh) => {
    const s = mesh.material.userData.shift || 0;
    mesh.material.map.offset.set(0.5 + s, 0.5);
    mesh.material.map.center.set(0.5, 0.5);
    mesh.material.needsUpdate = true;
  };
  applyShift(left);
  applyShift(right);

  video.addEventListener('loadedmetadata', ()=>{
    const aspect = video.videoWidth / Math.max(1, video.videoHeight);
    const width = 2.8, height = width / aspect;
    [left, right].forEach(mesh=>{
      mesh.geometry.dispose();
      mesh.geometry = new THREE.PlaneGeometry(width, height);
      applyShift(mesh);
    });
  });
}
// ------------------------------------

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

renderer.setAnimationLoop(() => {
  renderer.render(scene, camera);
});
</script>
</body>
</html>